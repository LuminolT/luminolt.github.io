<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Operating System | Luminolt</title><link>https://example.com/category/operating-system/</link><atom:link href="https://example.com/category/operating-system/index.xml" rel="self" type="application/rss+xml"/><description>Operating System</description><generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Tue, 06 Dec 2022 01:07:16 +0800</lastBuildDate><image><url>https://example.com/media/icon_hu1b90dea3b5752ec4ed6154c0dc881a21_30314_512x512_fill_lanczos_center_3.png</url><title>Operating System</title><link>https://example.com/category/operating-system/</link></image><item><title>Linux System Calls - File System</title><link>https://example.com/post/os-file-system/</link><pubDate>Tue, 06 Dec 2022 01:07:16 +0800</pubDate><guid>https://example.com/post/os-file-system/</guid><description>&lt;blockquote>
&lt;p>è¯·è§£é‡Šä»¥ä¸‹ç³»ç»Ÿè°ƒç”¨çš„è¯¦ç»†å«ä¹‰ã€‚&lt;/p>
&lt;p>&lt;code>open&lt;/code>, &lt;code>close&lt;/code>, &lt;code>read&lt;/code>, &lt;code>write&lt;/code>, &lt;code>lseek&lt;/code>, &lt;code>link&lt;/code>, &lt;code>mount&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h2 id="1---open">1 - &lt;code>open&lt;/code>&lt;/h2>
&lt;p>&lt;code>open&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pathname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">mode_t&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>pathname&lt;/code>è¡¨ç¤ºè¦æ‰“å¼€æ–‡ä»¶çš„è·¯å¾„ï¼Œ&lt;code>flags&lt;/code>è¡¨ç¤ºè®¿é—®æ¨¡å¼ï¼Œ&lt;code>mode&lt;/code>è¡¨ç¤ºæ–‡ä»¶æƒé™æŽ©ç ï¼Œåªèƒ½åœ¨æ–‡ä»¶åˆ›å»ºæ—¶ç”Ÿæ•ˆï¼ˆi.e. &lt;code>flags==O_CREAT&lt;/code>ï¼‰ï¼Œè¿”å›žå€¼æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ã€‚&lt;/p>
&lt;p>å…¶ä¸­ï¼Œ&lt;code>flags&lt;/code>å¿…é¡»åŒ…å«è®¿é—®æ¨¡å¼ï¼ŒåŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>åªè¯»æ¨¡å¼ï¼š&lt;code>O_RDONLY&lt;/code>&lt;/li>
&lt;li>åªå†™æ¨¡å¼ï¼š&lt;code>O_WRONLY&lt;/code>&lt;/li>
&lt;li>è¯»å†™æ¨¡å¼ï¼š&lt;code>O_RDWR&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>é™¤æ­¤ä¹‹å¤–çš„&lt;code>flags&lt;/code>å¯ä»¥é€šè¿‡æŒ‰ä½æˆ–çš„æ–¹å¼åŒæ—¶å¯ç”¨ï¼ŒåŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>O_APPEND&lt;/code>ï¼šå¢žåŠ æ¨¡å¼ï¼šæ–‡ä»¶åç§»é‡ç½®äºŽæ–‡ä»¶æœ«å°¾ï¼›&lt;/li>
&lt;li>&lt;code>O_CREAT&lt;/code>ï¼šåˆ›å»ºæ¨¡å¼ï¼šå½“&lt;code>pathname&lt;/code>ä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–‡ä»¶ï¼›&lt;/li>
&lt;li>&lt;code>O_TRUNC&lt;/code>ï¼šæˆªæ–­æ¨¡å¼ï¼šå½“æ–‡ä»¶å¯å†™ï¼Œåˆ™æŠ›å¼ƒåŽŸæ¥å†…å®¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåªå†™æ¨¡å¼çš„æ–‡ä»¶&lt;code>1.txt&lt;/code>ï¼Œæƒé™ä¸º&lt;code>rwxrwxrwx&lt;/code>ï¼Œå¯ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;1.txt&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">O_WRONLY&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">O_CREAT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0777&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2---close">2 - &lt;code>close&lt;/code>&lt;/h2>
&lt;p>&lt;code>close&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥å…³é—­ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>fd&lt;/code>è¡¨ç¤ºè¦å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚&lt;code>open&lt;/code>ç³»ç»Ÿè°ƒç”¨çš„è¿”å›žå€¼ï¼‰ã€‚
è¿”å›žå€¼ä¸º&lt;code>0&lt;/code>æ—¶ï¼Œè¡¨ç¤ºå…³é—­æˆåŠŸï¼Œä¸º&lt;code>-1&lt;/code>æ—¶ï¼Œè¡¨ç¤ºç³»ç»Ÿé”™è¯¯ï¼Œ
ä¸”åŒæ—¶&lt;code>errno&lt;/code>ä¼šè¢«è®¾ç½®ç”¨äºŽæŒ‡ç¤ºé”™è¯¯ç±»åž‹ä¿¡æ¯ã€‚&lt;/p>
&lt;h2 id="3---read">3 - &lt;code>read&lt;/code>&lt;/h2>
&lt;p>&lt;code>read&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥ä»Žä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¯»æ•°æ®ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">ssize_t&lt;/span> &lt;span class="nf">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">size_t&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>fd&lt;/code>è¡¨ç¤ºè¦è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆåŒä¸Šï¼‰ï¼Œ&lt;code>buf&lt;/code>æ˜¯æŒ‡å‘è¯»å–å­˜æ”¾ç©ºé—´çš„é¦–åœ°å€ï¼Œ
&lt;code>count&lt;/code>æ˜¯è¦è¯»å–å­—èŠ‚æ•°ã€‚æˆåŠŸè¯»å–æ—¶ï¼Œè¿”å›žè¯»å–çš„å­—èŠ‚æ•°*ï¼Œåä¹‹è¿”å›ž&lt;code>-1&lt;/code>ï¼Œè¡¨ç¤ºç³»ç»Ÿé”™è¯¯ã€‚&lt;/p>
&lt;p>*éœ€æ³¨æ„ï¼Œè¿”å›žå€¼å¯èƒ½ä¼šå°äºŽ&lt;code>count&lt;/code>å€¼ï¼Œè¯¥æƒ…å†µå‘ç”Ÿåœ¨è¯»å†…å®¹ä¸è¶³ï¼Œé‡åˆ°æ–‡ä»¶å°¾ï¼ˆEnd of File, EOFï¼‰æ—¶ã€‚&lt;/p>
&lt;h2 id="4---write">4 - &lt;code>write&lt;/code>&lt;/h2>
&lt;p>&lt;code>write&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥å‘ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å†™æ•°æ®ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">ssize_t&lt;/span> &lt;span class="nf">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">size_t&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>fd&lt;/code>è¡¨ç¤ºè¦å†™å…¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆåŒä¸Šï¼‰ï¼Œ&lt;code>buf&lt;/code>æ˜¯æŒ‡å‘å­˜æ”¾ç©ºé—´çš„é¦–åœ°å€ï¼Œ
&lt;code>count&lt;/code>æ˜¯è¦å†™å…¥å­—èŠ‚æ•°ã€‚æˆåŠŸè¯»å–æ—¶ï¼Œè¿”å›žå†™å…¥çš„å­—èŠ‚æ•°*ï¼Œåä¹‹è¿”å›ž&lt;code>-1&lt;/code>ï¼Œè¡¨ç¤ºç³»ç»Ÿé”™è¯¯ã€‚&lt;/p>
&lt;p>*åŒæ ·ï¼Œéœ€æ³¨æ„è¿”å›žå€¼å¯èƒ½ä¼šå°äºŽ&lt;code>count&lt;/code>å€¼ï¼Œè¯¥æƒ…å†µå‘ç”Ÿåœ¨å†™ç©ºé—´ä¸è¶³æ—¶ï¼ˆç©ºé—´æœ‰é™ï¼Œæˆ–è®¾ç½®äº†å†™å…¥ä¸Šé™&lt;code>RLIMIT_FSIZE&lt;/code>ï¼Œæˆ–è¢«ä¿¡å·ä¸­æ–­ï¼‰ã€‚&lt;/p>
&lt;h2 id="5---lseek">5 - &lt;code>lseek&lt;/code>&lt;/h2>
&lt;p>&lt;code>lseek&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥é‡å®šå‘è¯»å†™æ–‡ä»¶çš„åç§»é‡ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">off_t&lt;/span> &lt;span class="nf">lseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">off_t&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">whence&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>fd&lt;/code>è¡¨ç¤ºè¦æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ&lt;code>offset&lt;/code>è¡¨ç¤ºåç§»é‡ï¼Œ&lt;code>whence&lt;/code>è¡¨ç¤ºå¼€å§‹å¤„æ ‡å¿—ï¼ˆä»Žä½•å¤„å¼€å§‹ï¼‰ã€‚å½“æ“ä½œæˆåŠŸï¼Œè¿”å›žç»“æžœåç§»é‡ï¼Œåä¹‹è¿”å›ž&lt;code>-1&lt;/code>è¡¨ç¤ºé”™è¯¯ã€‚&lt;/p>
&lt;p>å…¶ä¸­&lt;code>whence&lt;/code>å¯å–å€¼ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>SEEK_SET&lt;/code>ï¼šæ–‡ä»¶åç§»é‡è®¾ç½®ä¸º&lt;code>offset&lt;/code>å­—èŠ‚ï¼›&lt;/li>
&lt;li>&lt;code>SEEK_CUR&lt;/code>ï¼šæ–‡ä»¶åç§»é‡è®¾ç½®ä¸ºå½“å‰åç§»é‡åŠ ä¸Š&lt;code>offset&lt;/code>å­—èŠ‚ï¼›&lt;/li>
&lt;li>&lt;code>SEEK_END&lt;/code>ï¼šæ–‡ä»¶åç§»é‡è®¾ç½®ä¸ºæ–‡ä»¶å¤§å°åŠ ä¸Š&lt;code>offset&lt;/code>å­—èŠ‚*ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸éš¾çœ‹å‡ºæ­¤å¤„åç§»é‡å¯ä»¥å¤§äºŽæ–‡ä»¶å¤§å°ã€‚å½“å¤§äºŽæ—¶ï¼Œè‹¥ç»§ç»­è°ƒç”¨&lt;code>write&lt;/code>ï¼Œåˆ™æ–‡ä»¶ä¸­ä¼šå‡ºçŽ°ä¸€æ®µç©ºéš™ï¼Œè¯¥ç©ºéš™ä¼šè¢«å¡«å……ä¸º&lt;code>\0&lt;/code>ã€‚&lt;/p>
&lt;h2 id="6---link">6 - &lt;code>link&lt;/code>&lt;/h2>
&lt;p>&lt;code>link&lt;/code>ç³»ç»Ÿè°ƒç”¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„ç¡¬é“¾æŽ¥ï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">link&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">oldpath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">newpath&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼Œ&lt;code>oldpath&lt;/code>è¡¨ç¤ºè¢«é“¾æŽ¥æ–‡ä»¶è·¯å¾„ï¼Œ&lt;code>newpath&lt;/code>è¡¨ç¤ºé“¾æŽ¥æ–‡ä»¶è·¯å¾„ã€‚
è¿”å›žå€¼ä¸º&lt;code>0&lt;/code>åˆ™è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼Œä¸º&lt;code>-1&lt;/code>æ—¶è¡¨ç¤ºåˆ›å»ºå¤±è´¥ã€‚&lt;/p>
&lt;p>å¦éœ€æ³¨æ„ï¼Œå½“&lt;code>newpath&lt;/code>éžç©ºæ—¶ï¼Œä¸ä¼šè¦†ç›–åŽŸæœ‰é“¾æŽ¥ï¼Œå¹¶ä¸”è¿”å›ž&lt;code>-1&lt;/code>ã€‚&lt;/p>
&lt;h2 id="7---mount">7 - &lt;code>mount&lt;/code>&lt;/h2>
&lt;p>&lt;code>mount&lt;/code>ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶å‡½æ•°åŽŸåž‹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">source&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">filesystemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">mountflags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>source&lt;/code>è¡¨ç¤ºè¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆç¡¬ä»¶è®¾å¤‡ã€æ–‡ä»¶ç›®å½•ç­‰ç­‰ï¼‰ï¼›&lt;/li>
&lt;li>&lt;code>target&lt;/code>è¡¨ç¤ºæŒ‚è½½è·¯å¾„ï¼›&lt;/li>
&lt;li>&lt;code>filesystemtype&lt;/code>è¡¨ç¤ºè¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿç±»åž‹ï¼ˆbtrfs, ext4, jfsç­‰ï¼‰ï¼›&lt;/li>
&lt;li>&lt;code>mountflags&lt;/code>è¡¨ç¤ºæ‰§è¡Œçš„æ“ä½œï¼›&lt;/li>
&lt;li>&lt;code>data&lt;/code>ç”±ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§£é‡Šï¼Œé€šå¸¸æ˜¯ä¸€ä¸²ä»¥é€—å·åˆ†éš”çš„é€‰é¡¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­ï¼Œ&lt;code>mountflags&lt;/code>å¯å–ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>MS_REMOUNT&lt;/code>ï¼šå¯¹å·²æœ‰çš„æŒ‚è½½é‡æŒ‚è½½ï¼›&lt;/li>
&lt;li>&lt;code>MS_BIND&lt;/code>ï¼šåˆ›å»ºç»‘å®šæŒ‚è½½ï¼›&lt;/li>
&lt;li>&lt;code>MS_SHARED, MS_PRIVATE, MS_SLAVE, MS_UNBINDABLE&lt;/code>ï¼šç”¨äºŽä¿®æ”¹å·²æœ‰æŒ‚è½½çš„è®¿é—®å±žæ€§ï¼ˆpropagation typeï¼‰ï¼›&lt;/li>
&lt;li>&lt;code>MS_MOVE&lt;/code>ï¼šå°†ä¸€ä¸ªçŽ°æœ‰çš„æŒ‚è½½ç§»åŠ¨åˆ°å¦ä¸€å¤„ï¼›&lt;/li>
&lt;li>ä¸ºç©ºæ—¶ï¼Œåˆ›å»ºæ–°æŒ‚è½½ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Reference: &lt;a href="https://man7.org/linux/man-pages/" target="_blank" rel="noopener">Linux Man Pages&lt;/a>&lt;/p>
&lt;/blockquote></description></item><item><title>A Brief Mannual to POSIX threads</title><link>https://example.com/post/pthreads/</link><pubDate>Tue, 11 Oct 2022 17:44:37 +0800</pubDate><guid>https://example.com/post/pthreads/</guid><description>&lt;h2 id="lead-in">Lead in&lt;/h2>
&lt;blockquote>
&lt;p>Aï¼šðŸ¤”ä¸ºä»€ä¹ˆæˆ‘å†™çš„ç¨‹åºè·‘çš„è¿™ä¹ˆæ…¢å‘¢&lt;/p>
&lt;p>Bï¼šðŸ˜‚check the serverï¼Œä¸€æ ¸æœ‰éš¾ä¸‡æ ¸å›´è§‚&lt;/p>
&lt;/blockquote>
&lt;img src="https://picgo-1303220879.cos.ap-shanghai.myqcloud.com/img/20221011090209.png" width="300" align="center"/>
&lt;p>åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿè¶Šæ¥è¶Šæ™®åŠçš„æ—¶ä»£ï¼Œä½ éœ€è¦å­¦ä¹ â€”â€”å¹¶å‘ç¼–ç¨‹ï¼&lt;/p>
&lt;p>POSIX ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹åº“ (pthreads)ï¼Œè¿™æ˜¯åœ¨å¤šæ ¸å¹³å°ä¸Šè¿›è¡Œå¹¶å‘ç¼–ç¨‹çš„ä¸€å¥—APIã€‚&lt;/p>
&lt;p>æœ¬æ–‡ï¼Œæˆ‘ä»¬ä»‹ç»ä¸‰ä¸ªå†…å®¹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚ä½•ä½¿ç”¨pthreadsåº“åˆ›å»ºå¹¶å‘çº¿ç¨‹&lt;/li>
&lt;li>å¦‚ä½•ä½¿ç”¨pthreadsåº“å®žçŽ°çº¿ç¨‹åŒæ­¥ï¼ˆå³OSåŒæ­¥åŽŸè¯­çš„ä½¿ç”¨ï¼‰&lt;/li>
&lt;li>çº¿ç¨‹APIçš„ä½¿ç”¨å‡†åˆ™&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Recallï¼šåœ¨ä½“ç³»ç»“æž„è¯¾ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†&lt;a href="https://en.wikipedia.org/wiki/OpenMP" target="_blank" rel="noopener">OpenMP&lt;/a>ï¼Œä¹Ÿæ˜¯å¹¶å‘ç¼–ç¨‹çš„ä¸€å¥—æŽ¥å£ï¼Œ
å…¶è§„èŒƒåœ¨ç¼–è¯‘å™¨ä¸Šå®žçŽ°ï¼Œç›¸è¾ƒäºŽpthreadsæ›´æ˜“äºŽæ‰©å±•ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="1-çº¿ç¨‹çš„åˆ›å»ºå’Œä½¿ç”¨">1 çº¿ç¨‹çš„åˆ›å»ºå’Œä½¿ç”¨&lt;/h2>
&lt;h3 id="11-ä¸»è¦å‡½æ•°æŽ¥å£">1.1 ä¸»è¦å‡½æ•°æŽ¥å£&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‡½æ•°å&lt;/th>
&lt;th>åŠŸèƒ½&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>int pthread_create()&lt;/code>&lt;/td>
&lt;td>åˆ›å»ºçº¿ç¨‹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_detach()&lt;/code>&lt;/td>
&lt;td>åˆ†ç¦»çº¿ç¨‹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_equal()&lt;/code>&lt;/td>
&lt;td>æ¯”è¾ƒçº¿ç¨‹ ID&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>void pthread_exit()&lt;/code>&lt;/td>
&lt;td>ç»ˆæ­¢çº¿ç¨‹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_join()&lt;/code>&lt;/td>
&lt;td>æŒ‚èµ·å¹¶ç­‰å¾…æŒ‡å®šçº¿ç¨‹ç»ˆæ­¢&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_kill()&lt;/code>&lt;/td>
&lt;td>å‘çº¿ç¨‹å‘é€ä¿¡å·&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_once()&lt;/code>&lt;/td>
&lt;td>ä»…ä¸€æ¬¡è°ƒç”¨æŒ‡å®šå‡½æ•°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_t pthread_self()&lt;/code>&lt;/td>
&lt;td>è¿”å›žçº¿ç¨‹ ID&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_cancel()&lt;/code>&lt;/td>
&lt;td>å‘çº¿ç¨‹å‘é€å–æ¶ˆä¿¡å·&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_setcancelstate()&lt;/code>&lt;/td>
&lt;td>è®¾ç½®æœ¬çº¿ç¨‹å¯¹å–æ¶ˆä¿¡å·çš„ååº”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_setcanceltype()&lt;/code>&lt;/td>
&lt;td>è®¾ç½®æœ¬çº¿ç¨‹å–æ¶ˆåŠ¨ä½œçš„æ‰§è¡Œæ—¶æœº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>void pthread_testcancel()&lt;/code>&lt;/td>
&lt;td>åˆ›å»ºçº¿ç¨‹å–æ¶ˆç‚¹&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="12-æŽ¥å£ç”¨æ³•">1.2 æŽ¥å£ç”¨æ³•&lt;/h3>
&lt;h4 id="121-åˆ›å»ºçº¿ç¨‹">1.2.1 åˆ›å»ºçº¿ç¨‹&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">thread&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">pthread_attr_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">start_routine&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>&lt;code>pthread_t *thread&lt;/code> ï¼šä¼ é€’ä¸€ä¸ª &lt;code>pthread_t&lt;/code> ç±»åž‹çš„æŒ‡é’ˆå˜é‡ï¼Œä¹Ÿå¯ä»¥ç›´æŽ¥ä¼ é€’æŸä¸ª &lt;code>pthread_t&lt;/code> ç±»åž‹å˜é‡çš„åœ°å€ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>const pthread_attr_t *attr&lt;/code>ï¼šç”¨äºŽæ‰‹åŠ¨è®¾ç½®æ–°å»ºçº¿ç¨‹çš„å±žæ€§ï¼Œä¾‹å¦‚çº¿ç¨‹çš„è°ƒç”¨ç­–ç•¥ã€çº¿ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æ ˆå†…å­˜çš„å¤§å°ç­‰ã€‚å¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹çº¿ç¨‹çš„å±žæ€§ï¼Œå°† &lt;code>attr&lt;/code> å‚æ•°èµ‹å€¼ä¸º &lt;code>NULL&lt;/code>ï¼Œ&lt;code>pthread_create()&lt;/code> å‡½æ•°ä¼šé‡‡ç”¨ç³»ç»Ÿé»˜è®¤çš„å±žæ€§å€¼åˆ›å»ºçº¿ç¨‹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>void *(*start_routine) (void *)&lt;/code>ï¼šä»¥å‡½æ•°æŒ‡é’ˆçš„æ–¹å¼æŒ‡æ˜Žæ–°å»ºçº¿ç¨‹éœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æœ€å¤šæœ‰ 1 ä¸ªï¼ˆå¯ä»¥çœç•¥ä¸å†™ï¼‰ï¼Œå½¢å‚å’Œè¿”å›žå€¼çš„ç±»åž‹éƒ½å¿…é¡»ä¸º &lt;code>void*&lt;/code> ç±»åž‹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>void *arg&lt;/code>ï¼šæŒ‡å®šä¼ é€’ç»™ &lt;code>start_routine&lt;/code> å‡½æ•°çš„å®žå‚ï¼Œå½“ä¸éœ€è¦ä¼ é€’ä»»ä½•æ•°æ®æ—¶ï¼Œå°† &lt;code>arg&lt;/code> èµ‹å€¼ä¸º &lt;code>NULL&lt;/code> å³å¯ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="122-åˆ†ç¦»çº¿ç¨‹">1.2.2 åˆ†ç¦»çº¿ç¨‹&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_detach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>è¡¨ç¤ºçº¿ç¨‹è¿è¡Œç»“æŸåŽèµ„æºå¯è¢«å›žæ”¶ï¼ˆçº¿ç¨‹æ‰€å ç”¨å †æ ˆå’Œçº¿ç¨‹æè¿°ç¬¦ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="123-æ¯”è¾ƒçº¿ç¨‹-id">1.2.3 æ¯”è¾ƒçº¿ç¨‹ ID&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="n">t1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">pthread_t&lt;/span> &lt;span class="n">t2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>æ¯”è¾ƒçº¿ç¨‹ &lt;code>t1&lt;/code> å’Œ &lt;code>t2&lt;/code> çš„çº¿ç¨‹ IDã€‚å¦‚æžœç›¸ç­‰ï¼Œè¿”å›žéžé›¶å€¼ï¼›å¦‚æžœä¸ç›¸ç­‰ï¼Œè¿”å›ž 0ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="124-ç»ˆæ­¢çº¿ç¨‹">1.2.4 ç»ˆæ­¢çº¿ç¨‹&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">pthread_exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">value_ptr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>void *value_ptr&lt;/code>ï¼š å¯ä»¥æŒ‡å‘ä»»ä½•ç±»åž‹çš„æ•°æ®ï¼Œå®ƒæŒ‡å‘çš„æ•°æ®å°†ä½œä¸ºçº¿ç¨‹é€€å‡ºæ—¶çš„è¿”å›žå€¼ã€‚å¦‚æžœçº¿ç¨‹ä¸éœ€è¦è¿”å›žä»»ä½•æ•°æ®ï¼Œå°†å‚æ•°ç½®ä¸º &lt;code>NULL&lt;/code> å³å¯ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="125-æŒ‚èµ·å¹¶ç­‰å¾…æŒ‡å®šçº¿ç¨‹ç»ˆæ­¢">1.2.5 æŒ‚èµ·å¹¶ç­‰å¾…æŒ‡å®šçº¿ç¨‹ç»ˆæ­¢&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">value_ptr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>pthread_t thread&lt;/code>ï¼šç­‰å¾…ç»ˆæ­¢çš„ç›®æ ‡çº¿ç¨‹ã€‚&lt;/li>
&lt;li>&lt;code>void **value_ptr&lt;/code>ï¼šæŽ¥æ”¶åˆ°çš„è¿”å›žå€¼ï¼Œä¸º &lt;code>void pthread_exit(void *value_ptr)&lt;/code> ä¸­ &lt;code>void *value_ptr&lt;/code> æŒ‡å‘çš„å†…å®¹ã€‚&lt;/li>
&lt;li>å¦‚æžœè°ƒç”¨ &lt;code>int pthread_join()&lt;/code> å‡½æ•°çš„çº¿ç¨‹è¢«å–æ¶ˆï¼Œç›®æ ‡çº¿ç¨‹ä¸ä¼šè¢«åˆ†ç¦»ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="126-å‘çº¿ç¨‹å‘é€ä¿¡å·">1.2.6 å‘çº¿ç¨‹å‘é€ä¿¡å·&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_kill&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">sig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>sig&lt;/code>ï¼šå‘æŒ‡å®šçº¿ç¨‹ &lt;code>pthread_t thread&lt;/code> å‘é€çš„ä¿¡å·ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="127-ä»…ä¸€æ¬¡è°ƒç”¨æŒ‡å®šå‡½æ•°">1.2.7 ä»…ä¸€æ¬¡è°ƒç”¨æŒ‡å®šå‡½æ•°&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">pthread_once_t&lt;/span> &lt;span class="n">once_control&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PTHREAD_ONCE_INIT&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_once&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_once_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">once_control&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">init_routine&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>pthread_once_t *once_control&lt;/code>ï¼šæŒ‡å®šå‡½æ•° &lt;code>init_routine&lt;/code> æ˜¯å¦è¢«è°ƒç”¨çš„æ ‡å¿—ï¼Œéœ€èµ‹åˆå€¼ &lt;code>PTHREAD_ONCE_INIT&lt;/code> ä»¥ä¿è¯ &lt;code>int pthread_once()&lt;/code> å‡½æ•°æ­£å¸¸è°ƒç”¨ã€‚&lt;/li>
&lt;li>&lt;code>void (*init_routine)(void)&lt;/code>ï¼šæŒ‡å®šå‡½æ•° &lt;code>init_routine&lt;/code>ï¼Œåœ¨ &lt;code>once_control&lt;/code> å€¼ä¸º &lt;code>PTHREAD_ONCE_INIT&lt;/code> æ—¶ï¼Œå¯è¢«æ­£å¸¸è°ƒç”¨ï¼ŒéšåŽä½¿ç”¨å†æ¬¡è°ƒç”¨ &lt;code>int pthread_once()&lt;/code> å‡½æ•°ä¸Žç›¸åŒ &lt;code>once_control&lt;/code>ï¼Œå°†ä¸ä¼šå†æ¬¡è°ƒç”¨ &lt;code>init_routine&lt;/code> å‡½æ•°ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="128-è¿”å›žçº¿ç¨‹-id">1.2.8 è¿”å›žçº¿ç¨‹ ID&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">pthread_t&lt;/span> &lt;span class="nf">pthread_self&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>è¿”å›žè°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹çš„çº¿ç¨‹ IDã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="129-å‘çº¿ç¨‹å‘é€å–æ¶ˆä¿¡å·">1.2.9 å‘çº¿ç¨‹å‘é€å–æ¶ˆä¿¡å·&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_t&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å‘é€ç»ˆæ­¢ä¿¡å·ç»™ &lt;code>thread&lt;/code> çº¿ç¨‹ï¼Œå¦‚æžœæˆåŠŸåˆ™è¿”å›ž 0ï¼Œå¦åˆ™ä¸ºéž 0 å€¼ã€‚å‘é€æˆåŠŸå¹¶ä¸æ„å‘³ç€ &lt;code>thread&lt;/code> ä¼šç»ˆæ­¢ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="1210-è®¾ç½®æœ¬çº¿ç¨‹å¯¹å–æ¶ˆä¿¡å·çš„ååº”">1.2.10 è®¾ç½®æœ¬çº¿ç¨‹å¯¹å–æ¶ˆä¿¡å·çš„ååº”&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_setcancelstate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">oldstate&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>int state&lt;/code> ï¼šå…·æœ‰ä¸¤ç§å–å€¼ &lt;code>PTHREAD_CANCEL_ENABLE&lt;/code>ï¼ˆç¼ºçœï¼‰å’Œ &lt;code>PTHREAD_CANCEL_DISABLE&lt;/code>ï¼Œ
åˆ†åˆ«è¡¨ç¤ºæ”¶åˆ°ä¿¡å·åŽè®¾ä¸º CANCLED çŠ¶æ€å’Œå¿½ç•¥ CANCEL ä¿¡å·ç»§ç»­è¿è¡Œï¼›&lt;code>old_state&lt;/code> å¦‚æžœä¸ä¸º &lt;code>NULL&lt;/code> åˆ™å­˜å…¥åŽŸæ¥çš„ Cancel çŠ¶æ€ä»¥ä¾¿æ¢å¤ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="1211-è®¾ç½®æœ¬çº¿ç¨‹å–æ¶ˆåŠ¨ä½œçš„æ‰§è¡Œæ—¶æœº">1.2.11 è®¾ç½®æœ¬çº¿ç¨‹å–æ¶ˆåŠ¨ä½œçš„æ‰§è¡Œæ—¶æœº&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_setcanceltype&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">oldtype&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>int type&lt;/code> ï¼šå…·æœ‰ä¸¤ç§å–å€¼ &lt;code>PTHREAD_CANCEL_DEFFERED&lt;/code> å’Œ &lt;code>PTHREAD_CANCEL_ASYCHRONOUS&lt;/code>ï¼Œä»…å½“ Cancel çŠ¶æ€ä¸º Enable æ—¶æœ‰æ•ˆï¼Œåˆ†åˆ«è¡¨ç¤ºæ”¶åˆ°ä¿¡å·åŽç»§ç»­è¿è¡Œè‡³ä¸‹ä¸€ä¸ªå–æ¶ˆç‚¹å†é€€å‡ºå’Œç«‹å³æ‰§è¡Œå–æ¶ˆåŠ¨ä½œï¼ˆé€€å‡ºï¼‰ï¼›&lt;code>oldtype&lt;/code> å¦‚æžœä¸ä¸º &lt;code>NULL&lt;/code> åˆ™å­˜å…¥è¿æ¥çš„å–æ¶ˆåŠ¨ä½œç±»åž‹å€¼ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="1212-åˆ›å»ºçº¿ç¨‹å–æ¶ˆç‚¹">1.2.12 åˆ›å»ºçº¿ç¨‹å–æ¶ˆç‚¹&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">pthread_testcancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>åœ¨ä¸åŒ…å«å–æ¶ˆç‚¹ï¼Œä½†æ˜¯åˆéœ€è¦å–æ¶ˆç‚¹çš„åœ°æ–¹åˆ›å»ºä¸€ä¸ªå–æ¶ˆç‚¹ï¼Œä»¥ä¾¿åœ¨ä¸€ä¸ªæ²¡æœ‰åŒ…å«å–æ¶ˆç‚¹çš„æ‰§è¡Œä»£ç çº¿ç¨‹ä¸­å“åº”å–æ¶ˆè¯·æ±‚ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="2-åŒæ­¥åŽŸè¯­">2 åŒæ­¥åŽŸè¯­&lt;/h2>
&lt;h3 id="21-äº’æ–¥é”">2.1 äº’æ–¥é”&lt;/h3>
&lt;h4 id="211ä¸»è¦å‡½æ•°æŽ¥å£">2.1.1ä¸»è¦å‡½æ•°æŽ¥å£&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‡½æ•°å&lt;/th>
&lt;th>åŠŸèƒ½&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>pthread_mutex_init()&lt;/code>&lt;/td>
&lt;td>åˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_mutex_destroy()&lt;/code>&lt;/td>
&lt;td>é”€æ¯ä¸€ä¸ªäº’æ–¥é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_mutex_lock()&lt;/code>&lt;/td>
&lt;td>åŠ é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_mutex_trylock()&lt;/code>&lt;/td>
&lt;td>å°è¯•åŠ é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_mutex_unlock()&lt;/code>&lt;/td>
&lt;td>è§£é”&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="212æŽ¥å£ç”¨æ³•">2.1.2æŽ¥å£ç”¨æ³•&lt;/h4>
&lt;h5 id="2121åˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”äº’æ–¥é‡">2.1.2.1åˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”(äº’æ–¥é‡)&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_mutex_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="kt">pthread_mutexattr_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>&lt;strong>mutex&lt;/strong>ï¼šä¼ å‡ºå‚æ•°ï¼Œè°ƒç”¨æ—¶åº”ä¼  &lt;strong>&amp;amp;mutex&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>attr&lt;/strong>ï¼šäº’æ–¥é‡å±žæ€§ã€‚æ˜¯ä¸€ä¸ªä¼ å…¥å‚æ•°ï¼Œé€šå¸¸ä¼ &lt;strong>NULL&lt;/strong>ï¼Œé€‰ç”¨&lt;strong>é»˜è®¤å±žæ€§&lt;/strong>(çº¿ç¨‹é—´å…±äº«)ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>äº’æ–¥é”åˆå§‹åŒ–æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>
&lt;p>é™æ€åˆå§‹åŒ–ï¼šå¦‚æžœäº’æ–¥é” &lt;strong>mutex&lt;/strong> æ˜¯é™æ€åˆ†é…çš„ï¼ˆå®šä¹‰åœ¨å…¨å±€ï¼Œæˆ–åŠ äº†staticå…³é”®å­—ä¿®é¥°ï¼‰ï¼Œå¯ä»¥ç›´æŽ¥ä½¿ç”¨å®è¿›è¡Œåˆå§‹åŒ–ã€‚&lt;code>e.g. pthead_mutex_t muetx = PTHREAD_MUTEX_INITIALIZER;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŠ¨æ€åˆå§‹åŒ–ï¼šå±€éƒ¨å˜é‡åº”é‡‡ç”¨åŠ¨æ€åˆå§‹åŒ–ã€‚&lt;code>e.g. pthread_mutex_init(&amp;amp;mutex, NULL)&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h5 id="2122-åŠ é”">2.1.2.2 &lt;strong>åŠ é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_mutex_lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¯è§†ä½œmutex&amp;ndash;&lt;/li>
&lt;/ul>
&lt;h5 id="2123-å°è¯•åŠ é”">2.1.2.3 &lt;strong>å°è¯•åŠ é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_mutex_trylock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2124è§£é”">2.1.2.4&lt;strong>è§£é”&lt;/strong>&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_mutex_unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¯è§†ä½œmutex++&lt;/li>
&lt;/ul>
&lt;h4 id="2125é”€æ¯äº’æ–¥é”">2.1.2.5&lt;strong>é”€æ¯äº’æ–¥é”&lt;/strong>&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_mutex_destroy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="22-æ¡ä»¶å˜é‡">2.2 æ¡ä»¶å˜é‡&lt;/h3>
&lt;h4 id="221ä¸»è¦å‡½æ•°æŽ¥å£">2.2.1ä¸»è¦å‡½æ•°æŽ¥å£&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‡½æ•°å&lt;/th>
&lt;th>åŠŸèƒ½&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>pthread_cond_init()&lt;/code>&lt;/td>
&lt;td>åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_cond_wait()&lt;/code>&lt;/td>
&lt;td>é˜»å¡žç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_cond_timedwait()&lt;/code>&lt;/td>
&lt;td>é™æ—¶ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_cond_signal()&lt;/code>&lt;/td>
&lt;td>å”¤é†’è‡³å°‘ä¸€ä¸ªé˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_cond_broadcast()&lt;/code>&lt;/td>
&lt;td>å”¤é†’å…¨éƒ¨é˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>pthread_cond_destroy()&lt;/code>&lt;/td>
&lt;td>é”€æ¯ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="222æŽ¥å£ç”¨æ³•">2.2.2æŽ¥å£ç”¨æ³•&lt;/h4>
&lt;h5 id="2221åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡">2.2.2.1&lt;strong>åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">cond&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="kt">pthread_condattr_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>&lt;strong>cond&lt;/strong>ï¼šä¼ å‡ºå‚æ•°ï¼Œä¼ å‡ºå‚æ•°ï¼Œè°ƒç”¨æ—¶åº”ä¼  &amp;amp;mutex&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>attr&lt;/strong>ï¼šattrè¡¨æ¡ä»¶å˜é‡å±žæ€§ï¼Œé€šå¸¸ä¸ºé»˜è®¤å€¼ï¼Œä¼ NULLå³å¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯ä»¥ä½¿ç”¨é™æ€åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œåˆå§‹åŒ–æ¡ä»¶å˜é‡ï¼š&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="n">cond&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PTHREAD_COND_INITIALIZER&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2222é˜»å¡žç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡">2.2.2.2&lt;strong>é˜»å¡žç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">cond&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å‡½æ•°ä½œç”¨ï¼š&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>
&lt;p>é˜»å¡žç­‰å¾…æ¡ä»¶å˜é‡condï¼ˆå‚1ï¼‰æ»¡è¶³&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é‡Šæ”¾å·²æŽŒæ¡çš„äº’æ–¥é”ï¼ˆè§£é”äº’æ–¥é‡ï¼‰ç›¸å½“äºŽ&lt;code>pthread_mutex_unlock(&amp;amp;mutex);&lt;/code>&lt;/p>
&lt;p>&lt;strong>1,2ä¸¤æ­¥ä¸ºä¸€ä¸ªåŽŸå­æ“ä½œã€‚&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å½“è¢«å”¤é†’ï¼Œ&lt;code>pthread_cond_waitå‡½æ•°è¿”å›žæ—¶ï¼Œè§£é™¤é˜»å¡žå¹¶é‡æ–°ç”³è¯·èŽ·å–äº’æ–¥é”&lt;/code>pthread_mutex_lock(&amp;amp;mutex);&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h5 id="2223é™æ—¶ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡">2.2.2.3&lt;strong>é™æ—¶ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_timedwait&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">cond&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">timespec&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kr">restrict&lt;/span> &lt;span class="n">abstime&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>abstimeï¼š&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>æŸ¥çœ‹struct timespecç»“æž„ä½“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="n">timespec&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">time_t&lt;/span> &lt;span class="n">tv_sec&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* seconds */&lt;/span> &lt;span class="err">ç§’&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">long&lt;/span> &lt;span class="n">tv_nsec&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* nanosecondes*/&lt;/span> &lt;span class="err">çº³ç§’&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>å½¢å‚abstimeä½¿ç”¨çš„æ˜¯ç»å¯¹æ—¶é—´ã€‚&lt;/strong>&lt;/p>
&lt;p>å¦‚ï¼štime(NULL)è¿”å›žçš„å°±æ˜¯ç»å¯¹æ—¶é—´ã€‚è€Œalarm(1)æ˜¯ç›¸å¯¹æ—¶é—´ï¼Œç›¸å¯¹å½“å‰æ—¶é—´å®šæ—¶1ç§’é’Ÿã€‚åˆå§‹åŒ–&lt;code>struct timespec t = {1, 0};&lt;/code>åˆ™&lt;code>pthread_cond_timedwait (&amp;amp;cond, &amp;amp;mutex, &amp;amp;t);&lt;/code> åªèƒ½å®šæ—¶åˆ° 1970å¹´1æœˆ1æ—¥ 00:00:01ç§’ ã€‚&lt;/p>
&lt;p>&lt;strong>æ­£ç¡®ç”¨æ³•ï¼š&lt;/strong>&lt;/p>
&lt;p>ä½¿ç”¨&lt;code>time_t cur = time(NULL); &lt;/code>èŽ·å–å½“å‰æ—¶é—´ã€‚&lt;/p>
&lt;p>åˆå§‹åŒ–&lt;code>struct timespec t;&lt;/code> å®šä¹‰timespec ç»“æž„ä½“å˜é‡t&lt;/p>
&lt;p>ä»¤&lt;code>t.tv_sec = cur+1;&lt;/code> å®šæ—¶1ç§’&lt;/p>
&lt;p>å†è¿›è¡Œä¼ å‚&lt;code>pthread_cond_timedwait (&amp;amp;cond, &amp;amp;mutex, &amp;amp;t); &lt;/code>ä¼ å‚&lt;/p>
&lt;h5 id="2224å”¤é†’è‡³å°‘ä¸€ä¸ªé˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹">2.2.2.4.&lt;strong>å”¤é†’è‡³å°‘ä¸€ä¸ªé˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_signal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2225å”¤é†’å…¨éƒ¨é˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹">2.2.2.5&lt;strong>å”¤é†’å…¨éƒ¨é˜»å¡žåœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_broadcast&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2226é”€æ¯ä¸€ä¸ªæ¡ä»¶å˜é‡">2.2.2.6&lt;strong>é”€æ¯ä¸€ä¸ªæ¡ä»¶å˜é‡&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_cond_destroy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="23-è¯»å†™é”">2.3 è¯»å†™é”&lt;/h3>
&lt;h4 id="231ä¸»è¦å‡½æ•°æŽ¥å£">2.3.1ä¸»è¦å‡½æ•°æŽ¥å£&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‡½æ•°å&lt;/th>
&lt;th>åŠŸèƒ½&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code> int pthread_rwlock_init()&lt;/code>&lt;/td>
&lt;td>åˆå§‹åŒ–ä¸€ä¸ªè¯»å†™é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_rwlock_rdlock()&lt;/code>&lt;/td>
&lt;td>åŠ è¯»é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code> int pthread_rwlock_wrlock()&lt;/code>&lt;/td>
&lt;td>åŠ å†™é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_rwlock_tryrdlock()&lt;/code>&lt;/td>
&lt;td>å°è¯•èŽ·å¾—è¯»æ¨¡å¼çš„è¯»å†™é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code> int pthread_rwlock_trywrlock()&lt;/code>&lt;/td>
&lt;td>å°è¯•èŽ·å¾—å†™æ¨¡å¼çš„è¯»å†™é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code> int pthread_rwlock_unlock()&lt;/code>&lt;/td>
&lt;td>é‡Šæ”¾è¯»å†™é”&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>int pthread_rwlock_destroy()&lt;/code>&lt;/td>
&lt;td>é”€æ¯è¯»å†™é”&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="232æŽ¥å£ç”¨æ³•">2.3.2æŽ¥å£ç”¨æ³•&lt;/h4>
&lt;h5 id="2321-åˆå§‹åŒ–ä¸€ä¸ªè¯»å†™é”">2.3.2.1 &lt;strong>åˆå§‹åŒ–ä¸€ä¸ªè¯»å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">rwlock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="kt">pthread_rwlockattr_t&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>rwclockä¸ºè¯»å†™é”æŒ‡é’ˆï¼Œatträ¸ºè¯»å†™é”å±žæ€§æŒ‡é’ˆã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡½æ•°æŒ‰è¯»å†™é”å±žæ€§å¯¹è¯»å†™é”è¿›è¡Œåˆå§‹åŒ–ã€‚å¦‚æžœ attr ä¸º NULLï¼Œåˆ™ä½¿â½¤ç¼ºçœçš„è¯»å†™é”å±žæ€§ï¼Œå…¶ä½œâ½¤ä¸Žä¼ é€’ç¼ºçœè¯»å†™é”å±žæ€§å¯¹è±¡çš„åœ°å€ç›¸åŒã€‚åˆå§‹åŒ–è¯»å†™é”ä¹‹åŽï¼Œè¯¥é”å¯ä»¥ä½¿â½¤ä»»æ„æ¬¡æ•°ï¼Œâ½½â½†éœ€é‡æ–°åˆå§‹åŒ–ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h5 id="2322-åŠ è¯»é”">2.3.2.2 &lt;strong>åŠ è¯»é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_rdlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>
&lt;p>åœ¨è¯»æ¨¡å¼ä¸‹é”å®šè¯»å†™é”ï¼ŒæˆåŠŸè¿”å›žï¼ï¼Œå¦åˆ™è¿”å›žé”™è¯¯ç¼–å·ï¼Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é”™è¯¯è¿”å›žå€¼çš„å®šä¹‰åªæ˜¯é’ˆå¯¹ä¸æ­£ç¡®ä½¿ç”¨è¯»å†™é”çš„æƒ…å†µ(å¦‚æœªç»åˆå§‹åŒ–çš„é”)ï¼Œæˆ–è€…è¯•å›¾èŽ·å–å·²æ‹¥æœ‰çš„é”ä»Žè€Œå¯èƒ½äº§ç”Ÿæ­»é”çš„æƒ…å†µã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h5 id="2323-åŠ å†™é”">2.3.2.3 &lt;strong>åŠ å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_wrlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>åœ¨å†™æ¨¡å¼ä¸‹é”å®šè¯»å†™é”,è¿”å›žå€¼å¦‚åŠ è¯»é”&lt;/li>
&lt;/ul>
&lt;h5 id="2324-å°è¯•èŽ·å¾—è¯»æ¨¡å¼çš„è¯»å†™é”">2.3.2.4 &lt;strong>å°è¯•èŽ·å¾—è¯»æ¨¡å¼çš„è¯»å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_tryrdlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¦‚æžœå¯ä»¥èŽ·å–è¿”å›ž0ï¼Œä¸å¯ä»¥èŽ·å–å‡ºé”™è¿”å›žEBUSY&lt;/li>
&lt;/ul>
&lt;h5 id="2325-å°è¯•èŽ·å¾—å†™æ¨¡å¼çš„è¯»å†™é”">2.3.2.5 &lt;strong>å°è¯•èŽ·å¾—å†™æ¨¡å¼çš„è¯»å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_trywrlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¦‚æžœå¯ä»¥èŽ·å–è¿”å›ž0ï¼Œä¸å¯ä»¥èŽ·å–å‡ºé”™è¿”å›žEBUSY&lt;/li>
&lt;/ul>
&lt;h5 id="2326-é‡Šæ”¾è¯»å†™é”">2.3.2.6 &lt;strong>é‡Šæ”¾è¯»å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>é‡Šæ”¾è¯»å†™é”ï¼ŒåŒ…æ‹¬è¯»é”ä¸Žå†™é”&lt;/li>
&lt;/ul>
&lt;h5 id="2327-é”€æ¯è¯»å†™é”">2.3.2.7 &lt;strong>é”€æ¯è¯»å†™é”&lt;/strong>&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">pthread_rwlock_destroy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">pthread_rwlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rwlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>æ­¤å‡½æ•°åªæ˜¯ååˆå§‹åŒ–è¯»å†™é”å˜é‡ï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œå¦‚æžœè¯»å†™é”å˜é‡æ˜¯é€šè¿‡mallocç­‰å‡½æ•°ç”³è¯·çš„ï¼Œé‚£ä¹ˆéœ€è¦åœ¨freeæŽ‰è¯»å†™é”å˜é‡ä¹‹å‰è°ƒç”¨pthread_rwlock_destoryå‡½æ•°ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="3-çº¿ç¨‹apiçš„ä½¿ç”¨å‡†åˆ™">3 çº¿ç¨‹APIçš„ä½¿ç”¨å‡†åˆ™&lt;/h2>
&lt;blockquote>
&lt;p>æ­¤éƒ¨åˆ†è¯‘è‡ªOSTEP 27.6 Summary&lt;/p>
&lt;/blockquote>
&lt;p>å½“ä½ ä½¿ç”¨çº¿ç¨‹åº“æ¥æž„å»ºç¨‹åºæ—¶ï¼Œå¿…é¡»è®°ä½ä¸€äº›xioä½†å¾ˆé‡è¦çš„äº‹æƒ…ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ä¿æŒç®€å•&lt;/strong>ï¼š è¿™æ˜¯æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼Œä½ åº”è¯¥å°½é‡ä¿æŒä½ æ¶‰åŠåˆ°é”å®šå’Œå‘å‡ºä¿¡å·ï¼ˆlock&amp;amp;signalï¼‰çš„ä»£ç 
ç®€å•ï¼Œä»¥å…å‡ºçŽ°ä¸€äº›ç¥žå¿…çš„çº¿ç¨‹é—´ç›¸äº’ä½œç”¨å¯¼è‡´çš„é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;strong>å°½é‡å‡å°‘çº¿ç¨‹ä¹‹é—´çš„äº’åŠ¨&lt;/strong>ï¼šæ¯ä¸€ç§äº¤äº’éƒ½åº”è¯¥éƒ½è¦ä»”ç»†è€ƒè™‘ï¼Œå¹¶é‡‡ç”¨ç»è¿‡éªŒè¯çš„æ–¹æ³•æ¥æž„å»ºã€‚&lt;/li>
&lt;li>&lt;strong>åˆå§‹åŒ–åŒæ­¥åŽŸè¯­&lt;/strong>ï¼šå¦‚æžœä¸è¿™ä¹ˆåšï¼Œæœ‰æ—¶ä¼šå‡ºçŽ°ä½ åœ¨è°ƒè¯•æ—¶ðŸˆšé—®é¢˜ï¼Œä½†æ˜¯ä¸ŠçŽ¯å¢ƒä»¥åŽå‡ºçŽ°éžå¸¸è¯¡å¼‚çš„é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;strong>æ£€æŸ¥ä½ çš„è¿”å›žä»£ç &lt;/strong>ï¼šå½“ç„¶ï¼Œåœ¨ä½ åšçš„ä»»ä½•Cå’ŒUNIXç¼–ç¨‹ä¸­ï¼Œä½ åº”è¯¥æ£€æŸ¥æ¯ä¸€ä¸ªè¿”å›žä»£ç ã€‚
è¿™é‡Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¦‚æžœä¸è¿™æ ·åšï¼Œå°±ä¼šå¯¼è‡´å¥‡æ€ªçš„å’Œéš¾ä»¥ç†è§£çš„è¡Œä¸ºï¼Œ&lt;del>å¯¼è‡´ä½ ç ¸é”®ç›˜&lt;/del>ã€‚&lt;/li>
&lt;li>&lt;strong>åœ¨ä¼ é€’å‚æ•°å’Œè¿”å›žå€¼æ—¶å°å¿ƒå¤„ç†&lt;/strong>ï¼šç‰¹åˆ«æ˜¯åœ¨ä¼ é€’åœ¨å †æ ˆç©ºé—´å†…çš„æŒ‡é’ˆæ—¶ï¼Œä½ å¯èƒ½ä¼šå‡ºé”™ã€‚&lt;/li>
&lt;li>&lt;strong>æ³¨æ„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å †æ ˆ&lt;/strong>ï¼šè¿™å’Œä¸Šä¸€æ¡ç›¸å…³è¯·è®°ä½ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å †æ ˆã€‚å› æ­¤ï¼Œå¦‚æžœä½ æœ‰ä¸€ä¸ª
æœ¬åœ°åˆ†é…çš„å˜é‡ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯è¯¥çº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼›å…¶ä»–çº¿ç¨‹ä¸å¯èƒ½(è½»æ˜“ï¼‰è®¿é—®å®ƒã€‚è¦åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«æ•°æ®ï¼Œè¿™äº›å€¼å¿…é¡»åœ¨
åœ¨å †ä¸­ï¼Œæˆ–è€…å…¶ä»–ä¸€äº›å…¨å±€å¯è®¿é—®çš„ä½ç½®ã€‚&lt;/li>
&lt;li>&lt;strong>è¯·ä½¿ç”¨æ¡ä»¶å˜é‡åœ¨çº¿ç¨‹é—´ä¼ é€’ä¿¡å·&lt;/strong>ï¼šè™½ç„¶ä½¿ç”¨ä¿¡å·ï¼ˆsignal flagï¼‰å¾ˆç®€å•ä¸”è¯±äººï¼Œä½†æ˜¯è¯·ä¸è¦è¿™ä¹ˆåšã€‚&lt;/li>
&lt;li>&lt;strong>æŸ¥çœ‹æ‰‹å†Œ&lt;/strong>&lt;del>RTFM&lt;/del>ï¼šç‰¹åˆ«æ˜¯åœ¨Linuxä¸Šï¼Œpthread æ‰‹å†Œçš„ä¿¡æ¯é‡å¾ˆå¤§ï¼Œè®¨è®ºäº†å¾ˆå¤šè¿™é‡Œæå‡ºçš„ç»†å¾®å·®åˆ«ï¼Œé€šå¸¸ç”šè‡³æ›´è¯¦ç»†ã€‚ä»”ç»†é˜…è¯»å®ƒä»¬å§~&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Pthreads" target="_blank" rel="noopener">pthreads Wiki&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.ibm.com/docs/en/aix/7.2?topic=files-pthreadh-file" target="_blank" rel="noopener">pthread.h Document by IBM&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://pubs.opengroup.org/onlinepubs/7908799/xsh/pthread.h.html" target="_blank" rel="noopener">pthread.h Document by OpenGroup&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://pages.cs.wisc.edu/~remzi/OSTEP/" target="_blank" rel="noopener">Operating System: Three Easy Pieces&lt;/a>,Remzi H. Arpaci-Dusseau and Andrea C. Arpaci-Dusseau, Arpaci-Dusseau Books, August, 2018 (Version 1.00)&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>About Semaphore</title><link>https://example.com/post/about-semaphore/</link><pubDate>Tue, 11 Oct 2022 12:06:12 +0800</pubDate><guid>https://example.com/post/about-semaphore/</guid><description>&lt;p>&lt;strong>ä¿¡å·é‡åº”ç”¨ 3ã€ç”¨ä¿¡å·é‡æè¿°åŒæ­¥ï¼š&lt;/strong>&lt;/p>
&lt;p>&lt;strong>ä¾‹ï¼š&lt;/strong> æŸæŽ§åˆ¶æµ‹é‡ç³»ç»Ÿä¸­ï¼Œæ•°æ®é‡‡é›†ä»»åŠ¡åå¤æŠŠ
æ‰€é‡‡é›†çš„æ•°æ®é€å…¥ä¸€ä¸ªå•ç¼“å†²åŒºï¼›è®¡ç®—ä»»åŠ¡ä¸æ–­ä»Ž
è¯¥å•ç¼“å†²åŒºå–å‡ºæ•°æ®è¿›è¡Œè®¡ç®—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="n">var&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="n">flag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">collection&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ture&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡‡é›†æ•°æ®ï¼›
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flag&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å°†é‡‡é›†çš„æ•°æ®æ”¾å…¥buffer;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">flag&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">calculate&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ture&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flag&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä»Žbufä¸­å–å‡ºæ•°æ®;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">flag&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¡ç®—å¤„ç†;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ðŸ¤” &lt;strong>æ­¤å¤„ä½¿ç”¨signal flagæ›¿ä»£ä¿¡å·é‡ï¼Œä¼šä¸ä¼šäº§ç”Ÿé—®é¢˜ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Answer&lt;/strong>ï¼šå¯ä»¥çœ‹åˆ°æ­¤å¤„&lt;code>while(flag==1);&lt;/code>å’Œ&lt;code>while(flag==0);&lt;/code>å‡ä¸ºå¾ªçŽ¯å¿™ç­‰çš„æ“ä½œï¼Œ
å› æ­¤è¯¥æ–¹æ³•å’Œæ•™æä¸­æ•´åž‹ä¿¡å·é‡æ˜¯ä¸€è‡´çš„ï¼Œå› æ­¤ä¼šå‡ºçŽ°&lt;strong>è®©æƒç­‰å¾…&lt;/strong>ã€&lt;strong>æœ‰é™ç­‰å¾…&lt;/strong>ä¸æ»¡è¶³çš„é—®é¢˜ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ðŸ˜‰ é—®é¢˜è§£ç­”ç»“æŸï¼Œä»¥ä¸‹ä¸ºç›¸å…³çš„è¡¥å……å†…å®¹&lt;/p>
&lt;/blockquote>
&lt;h2 id="1-æ•´åž‹ä¿¡å·é‡">1 æ•´åž‹ä¿¡å·é‡&lt;/h2>
&lt;p>æ•™æï¼šæ•´åž‹ä¿¡å·é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">semaphore&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sem&lt;/span>&lt;span class="o">&amp;lt;=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">;&lt;/span> &lt;span class="cm">/* å¾ªçŽ¯å¿™ç­‰ */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sem&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sem&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å­˜åœ¨å¾ªçŽ¯å¿™ç­‰ï¼Œå’ŒPPTç»™å‡ºæ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œè¯¥æ–¹æ³•æ˜¾ç„¶ä¸æ»¡è¶³ï¼š&lt;/p>
&lt;ul>
&lt;li>è®©æƒç­‰å¾…ï¼šPæ“ä½œå¾ªçŽ¯å¿™ç­‰ã€‚&lt;/li>
&lt;li>æœ‰é™ç­‰å¾…ï¼šæŸä¸€çº¿ç¨‹Væ“ä½œåŽå…¶ä½™çº¿ç¨‹ç«žäº‰èµ„æºï¼Œå…¶ç»“æžœä¸ç¡®å®šã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="2-æ•´åž‹ä¿¡å·é‡çš„å°æ”¹è¿›">2 æ•´åž‹ä¿¡å·é‡çš„å°æ”¹è¿›&lt;/h2>
&lt;p>æ­¤å¤„æˆ‘ä»¬æ¶ˆé™¤å¾ªçŽ¯å¿™ç­‰çš„è¿‡ç¨‹ï¼Œé€šè¿‡&lt;code>yield()&lt;/code>è®©çº¿ç¨‹è½¬è®©CPUä½¿ç”¨æƒã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">semaphore&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">bool&lt;/span> &lt;span class="n">succ&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">succ&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sem&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sem&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">succ&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">succ&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">yield&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sem&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯æ­¤æ—¶å‘çŽ°ä»…æ»¡è¶³è®©æƒç­‰å¾…ï¼ˆ&lt;code>yield()&lt;/code>å¯¹åº”çº¿ç¨‹è®©æƒï¼‰ï¼Œä½†ä¸æ»¡è¶³æœ‰é™ç­‰å¾…ï¼ˆåŒ1éƒ¨åˆ†ï¼‰ã€‚&lt;/p>
&lt;h2 id="3-è®°å½•åž‹ä¿¡å·é‡">3 è®°å½•åž‹ä¿¡å·é‡&lt;/h2>
&lt;p>æ•™æï¼šè®°å½•åž‹ä¿¡å·é‡ï¼šåˆ©ç”¨PCBé“¾å¼é˜Ÿåˆ—å®žçŽ°ï¼Œä»…éœ€ä¿è¯å•æ¡æ“ä½œçš„åŽŸå­æ€§ï¼ˆthrough model-checkerï¼‰&lt;/p>
&lt;blockquote>
&lt;p>model-checker &lt;a href="https://luminolt.cn/resources/semaphore/" target="_blank" rel="noopener">ä¿¡å·é‡çš„çŠ¶æ€è½¬ç§»å›¾&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">PCB&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="n">semaphore&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">block&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">semaphore&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">wakeup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">S&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="4-ä¿¡å·é‡apiå®žçŽ°">4 ä¿¡å·é‡ï¼ˆAPIå®žçŽ°ï¼‰&lt;/h2>
&lt;p>è¿›ä¸€æ­¥ï¼šä¿¡å·é‡å®žé™…çš„å®žçŽ°ï¼Œæ€æƒ³å’Œæ•™æä¸­çš„è®°å½•åž‹ä¿¡å·é‡ç›¸åŒï¼Œå¯¹åº”&lt;code>semaphore.h&lt;/code>
çš„æŠ½è±¡ã€‚ç”±äºŽ&lt;code>semaphore.h&lt;/code>çš„æºç ä¸æ˜¯å¾ˆå¥½æ‰¾ï¼ˆç¬”è€…çš„ç³»ç»Ÿä¸Šè¿™ä¸ªè¢«é“¾æŽ¥äº†ï¼Œéœ€è¦ä¸€äº›
åæ±‡ç¼–ï¼‰ï¼Œæ­¤å¤„ç»™å‡ºOSTEPçš„å®žçŽ°ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Ref: &lt;a href="https://github.com/remzi-arpacidusseau/ostep-code/blob/master/threads-sema/zemaphore.h" target="_blank" rel="noopener">https://github.com/remzi-arpacidusseau/ostep-code/blob/master/threads-sema/zemaphore.h&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#ifndef __zemaphore_h__
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define __zemaphore_h__
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">__Zem_t&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">pthread_cond_t&lt;/span> &lt;span class="n">cond&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">pthread_mutex_t&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="n">Zem_t&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">Zem_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Zem_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Cond_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Mutex_init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">Zem_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Zem_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Mutex_lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Cond_wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Mutex_unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">Zem_post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Zem_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Mutex_lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Cond_signal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">cond&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Mutex_unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#ifdef __APPLE__
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="k">typedef&lt;/span> &lt;span class="n">Zem_t&lt;/span> &lt;span class="kt">sem_t&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define Sem_wait(s) Zem_wait(s)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define Sem_post(s) Zem_post(s)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define Sem_init(s, v) Zem_init(s, v)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#endif &lt;/span>&lt;span class="c1">// __zemaphore_h__
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ä¸€ä¸ªäº’æ–¥é”å’Œæ¡ä»¶å˜é‡ã€‚&lt;/p>
&lt;p>äº‹å®žä¸Šæ¡ä»¶å˜é‡å¯¹åº”ä¸Šé¢çš„çš„PCBé˜Ÿåˆ—ï¼Œè€Œ&lt;code>block()&lt;/code>å’Œ&lt;code>wakeup()&lt;/code>çš„åŽŸå­æ€§ï¼Œ
å¯¹åº”è¿™é‡Œæ¡ä»¶å˜é‡çš„&lt;code>wait()&lt;/code>å’Œ&lt;code>signal()&lt;/code>é€šè¿‡äº’æ–¥é”ä¿è¯ã€‚&lt;/p></description></item></channel></rss>